# -*- coding: utf-8 -*-
"""app7

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1KpQQ3HhfGKGYGf8oDd6WvPc1eevP1J0k
"""

import streamlit as st
import pandas as pd
import random

# --- 1. ì°¸ê°€ì ì„¤ì • (24ëª…) ---
PARTICIPANTS = ["ë‹¨ë¹„", "ì°½ìš°", "ì£¼í¬", "ì˜¨ìœ ", "ìœ ë¯¼", "ì£¼í˜•", "ì˜ˆìŠ¬", "ë„í˜„", "ì„±í˜„", "ì‹ ì˜", "ì¤€ì¼", "ì£¼í™©", "ì§„ìˆ˜", "ì˜ì°¬", "ë‹¤ì—°", "ì˜ˆì›", "ì£¼í˜„", "ì´ëª…", "ì—°ì œ", "ìœ¤ì•„", "ë§ˆë¦¬ì•„", "ê·œì§„", "ì£¼í•œ", "ê±´ì–‘"]

# --- 2. í•‘í¬ ê°ì„± í…Œë§ˆ & UI ë ˆì´ì•„ì›ƒ ì„¤ì • ---
st.set_page_config(page_title="ğŸ’– X-Signal", layout="centered")

# ë°°ê²½ìƒ‰, ê¸€ììƒ‰, ë²„íŠ¼ ëª¨ì–‘ ë“± í•‘í¬ë¹› ê°ì„± ìœ ì§€
st.markdown("""
    <style>
    .stApp { background: linear-gradient(180deg, #fff5f7 0%, #ffe4e8 100%); }
    h1, h2, h3 { color: #ff6b81 !important; font-family: 'Nanum Pen Script', sans-serif; }
    /* ë²„íŠ¼ì„ ë‘¥ê¸€ê³  í•‘í¬í•˜ê²Œ */
    .stButton>button { border-radius: 20px; border: 1px solid #ffb7c5; color: #ff6b81; background-color: white; }
    .stButton>button:hover { background-color: #fff5f7; border-color: #ff6b81; }
    /* íƒ­ ë©”ë‰´ ë””ìì¸ */
    .stTabs [data-baseweb="tab-list"] { background-color: transparent; }
    .stTabs [data-baseweb="tab"] { color: #ff8fa3; font-weight: bold; }
    </style>
    """, unsafe_allow_html=True)

# --- 3. ë°ì´í„° ì‹œìŠ¤í…œ ì´ˆê¸°í™” ---
if 'db' not in st.session_state:
    targets = PARTICIPANTS[:]
    while True:
        random.shuffle(targets)
        if all(PARTICIPANTS[i] != targets[i] for i in range(len(PARTICIPANTS))): break

    db = {}
    for i, name in enumerate(PARTICIPANTS):
        target_name = targets[i]
        db[name] = {
            "nickname": f"{target_name}ë˜",
            "avatar": f"https://api.dicebear.com/7.x/adventurer/svg?seed={name}{i}",
            "target": target_name,
            "x_chat": []
        }
    st.session_state.db = db
    st.session_state.global_chat = []

# --- 4. ë¡œê·¸ì¸ í™”ë©´ ---
if 'user' not in st.session_state:
    st.markdown("<h1 style='text-align: center;'>ğŸ’– X-Signal</h1>", unsafe_allow_html=True)
    st.markdown("<p style='text-align: center; color: #ff8fa3;'>ë‹¹ì‹ ì˜ XëŠ” ë‹¹ì‹ ì„ ì„ íƒí–ˆìŠµë‹ˆê¹Œ?</p>", unsafe_allow_html=True)

    with st.container(border=True):
        name_select = st.selectbox("ë‹¹ì‹ ì˜ ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”", ["ì„ íƒí•˜ì„¸ìš”", "ìš´ì˜ì"] + PARTICIPANTS)
        if name_select == "ìš´ì˜ì":
            pw = st.text_input("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸", type="password")
            if st.button("ìš´ì˜ì ì ‘ì†", use_container_width=True):
                if pw == "1234":
                    st.session_state.user = "ìš´ì˜ì"
                    st.rerun()
        elif name_select != "ì„ íƒí•˜ì„¸ìš”":
            if st.button(f"{name_select}ë‹˜ìœ¼ë¡œ ì…ì¥í•˜ê¸°", use_container_width=True):
                st.session_state.user = name_select
                st.rerun()

# --- 5. ë©”ì¸ ì•± í™”ë©´ ---
else:
    user = st.session_state.user

    # ì‚¬ì´ë“œë°”: ë‚´ í”„ë¡œí•„ê³¼ ë§ˆë‹ˆë˜(X) ì •ë³´ ìƒì‹œ ê³ ì •
    with st.sidebar:
        st.markdown(f"## ğŸ‘¤ ë‚´ í”„ë¡œí•„")
        if user != "ìš´ì˜ì":
            my = st.session_state.db[user]
            st.image(my['avatar'], width=100)
            st.markdown(f"**ë‹‰ë„¤ì„:** `{my['nickname']}`")
            st.markdown(f"**ë‹¹ì‹ ì˜ X(ëŒ€ìƒ):** <span style='color:#ff6b81; font-size:20px; font-weight:bold;'>{my['target']}</span>", unsafe_allow_html=True)
            st.divider()

        if st.button("ğŸšª ë¡œê·¸ì•„ì›ƒ", use_container_width=True):
            del st.session_state.user
            st.rerun()

    if user == "ìš´ì˜ì":
        st.title("ğŸ•¶ï¸ ê´€ë¦¬ì íŒ¨ë„")
        m_df = pd.DataFrame([{"ì´ë¦„": k, "X(ëŒ€ìƒ)": v['target']} for k, v in st.session_state.db.items()])
        st.dataframe(m_df, use_container_width=True)

    else:
        my = st.session_state.db[user]
        tab1, tab2, tab3 = st.tabs(["ğŸ’¬ í•‘í¬í†¡", "ğŸ’Œ X-ëŒ€í™”", "ğŸ¯ ì¶”ë¦¬"])

        # [íƒ­ 1: ë‹¨ì²´í†¡] - ì½”ë“œê°€ ë…¸ì¶œë˜ì§€ ì•ŠëŠ” ì •ì‹ ì±„íŒ… UI
        with tab1:
            st.markdown("### ğŸŒ¸ í•‘í¬ ì‹œê·¸ë„ ê´‘ì¥")

            with st.container():
                col1, col2 = st.columns([3, 1])
                # ì´ë¯¸ì§€ ì—…ë¡œë”ë¥¼ ìœ„ë¡œ ë°°ì¹˜í•˜ì—¬ ê°€ë…ì„± í™•ë³´
                chat_img = col2.file_uploader("ğŸ–¼ï¸", type=['jpg','png'], label_visibility="collapsed")
                chat_msg = st.chat_input("ìµëª…ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ë‚¨ê¸°ì„¸ìš”...")

                if chat_msg:
                    st.session_state.global_chat.append({
                        "name": my['nickname'], "avatar": my['avatar'], "msg": chat_msg, "img": chat_img
                    })
                    st.rerun()

            for c in reversed(st.session_state.global_chat):
                with st.chat_message("user", avatar=c['avatar']):
                    st.write(f"**{c['name']}**")
                    if c['msg']: st.write(c['msg'])
                    if c['img']: st.image(c['img'], width=250)

        # [íƒ­ 2: X-ëŒ€í™”] - 1:1 ëŒ€í™”ë°© í˜•ì‹
        with tab2:
            st.markdown(f"### ğŸ’Œ {my['target']}ë‹˜ê³¼ì˜ ë¹„ë°€ ëŒ€í™”")
            target_db = st.session_state.db[my['target']]

            x_input = st.chat_input("Xì—ê²Œë§Œ ë³´ì´ëŠ” ë©”ì‹œì§€ë¥¼ ë³´ë‚´ì„¸ìš”...", key="x_chat_input")
            if x_input:
                my['x_chat'].append({"role": "sent", "msg": x_input})
                target_db['x_chat'].append({"role": "received", "sender": my['nickname'], "msg": x_input})
                st.toast("ì‹œê·¸ë„ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤! â¤ï¸")
                st.rerun()

            st.divider()
            for chat in reversed(my['x_chat']):
                if chat['role'] == "received":
                    with st.chat_message("assistant", avatar="ğŸ’–"):
                        st.write(f"**{chat['sender']}ë‹˜ìœ¼ë¡œë¶€í„°**")
                        st.write(chat['msg'])
                else:
                    with st.chat_message("user", avatar="ğŸ“¤"):
                        st.write("**ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€**")
                        st.write(chat['msg'])

        # [íƒ­ 3: ì¶”ë¦¬] - í™˜ìŠ¹ì—°ì•  í•µì‹¬ ë¬¸êµ¬ ê°•ì¡°
        with tab3:
            st.markdown("<div style='text-align: center; padding: 30px; border-radius: 20px; background-color: white; border: 2px solid #ffb7c5;'>", unsafe_allow_html=True)
            st.markdown(f"## \"ë‹¹ì‹ ì˜ XëŠ” ë‹¹ì‹ ì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤\"")
            st.markdown("</div>", unsafe_allow_html=True)

            st.write("")
            guess = st.selectbox("ëˆ„ê°€ ë‹¹ì‹ ì„ ë§ˆë‹ˆë˜ë¡œ ì±™ê¸°ê³  ìˆë‚˜ìš”?", ["ì„ íƒí•˜ì„¸ìš”"] + PARTICIPANTS)
            if st.button("ìµœì¢… í™•ì¸", use_container_width=True):
                real_x = [k for k, v in st.session_state.db.items() if v['target'] == user][0]
                if guess == real_x:
                    st.balloons()
                    st.success(f"ì •ë‹µì…ë‹ˆë‹¤! {real_x}ë‹˜ì´ ë‹¹ì‹ ì˜ ë§ˆë‹ˆë˜ì˜€ìŠµë‹ˆë‹¤. ğŸ’–")
                else:
                    st.error("ì•„ì‰½ì§€ë§Œ ì •ë‹µì´ ì•„ë‹™ë‹ˆë‹¤. ë‹¤ì‹œ ì¶”ë¦¬í•´ë³´ì„¸ìš”! ğŸ¤«")