# -*- coding: utf-8 -*-
"""app6

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1KpQQ3HhfGKGYGf8oDd6WvPc1eevP1J0k
"""

import streamlit as st
import pandas as pd
import random

# --- 1. ì°¸ê°€ì ì„¤ì • (24ëª…) ---
PARTICIPANTS = ["ë‹¨ë¹„", "ì°½ìš°", "ì£¼í¬", "ì˜¨ìœ ", "ìœ ë¯¼", "ì£¼í˜•", "ì˜ˆìŠ¬", "ë„í˜„", "ì„±í˜„", "ì‹ ì˜", "ì¤€ì¼", "ì£¼í™©", "ì§„ìˆ˜", "ì˜ì°¬", "ë‹¤ì—°", "ì˜ˆì›", "ì£¼í˜„", "ì´ëª…", "ì—°ì œ", "ìœ¤ì•„", "ë§ˆë¦¬ì•„", "ê·œì§„", "ì£¼í•œ", "ê±´ì–‘"]

# --- 2. í•‘í¬ ê°ì„± í…Œë§ˆ ì„¤ì • ---
st.set_page_config(page_title="ğŸ’– X-Signal", layout="centered")

st.markdown("""
    <style>
    .stApp { background-color: #fff5f7; }
    h1, h2, h3 { color: #ff6b81 !important; }
    .stTabs [data-baseweb="tab-list"] { background-color: transparent; }
    .stTabs [data-baseweb="tab"] { color: #ff8fa3; font-weight: bold; font-size: 16px; }
    /* ì±„íŒ… ì…ë ¥ì°½ í•‘í¬ìƒ‰ ê°•ì¡° */
    div[data-testid="stChatInput"] { border-radius: 20px; border: 2px solid #ffb7c5; }
    </style>
    """, unsafe_allow_html=True)

# --- 3. ë°ì´í„° ì´ˆê¸°í™” (ì„œë²„ë‹¹ 1íšŒ) ---
if 'db' not in st.session_state:
    targets = PARTICIPANTS[:]
    while True:
        random.shuffle(targets)
        if all(PARTICIPANTS[i] != targets[i] for i in range(len(PARTICIPANTS))): break

    db = {}
    for i, name in enumerate(PARTICIPANTS):
        target_name = targets[i]
        db[name] = {
            "nickname": f"{target_name}ë˜",
            "avatar": f"https://api.dicebear.com/7.x/adventurer/svg?seed={name}",
            "target": target_name,
            "x_chat": []
        }
    st.session_state.db = db
    st.session_state.global_chat = []

# --- 4. ë¡œê·¸ì¸ í™”ë©´ ---
if 'user' not in st.session_state:
    st.markdown("<h1 style='text-align: center;'>ğŸ’– X-Signal</h1>", unsafe_allow_html=True)
    st.markdown("<p style='text-align: center; color: #ff8fa3;'>ë‹¹ì‹ ì˜ XëŠ” ë‹¹ì‹ ì„ ì„ íƒí–ˆìŠµë‹ˆê¹Œ?</p>", unsafe_allow_html=True)

    with st.expander("ì…ì¥í•˜ê¸°", expanded=True):
        name_select = st.selectbox("ë³¸ì¸ ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”", ["ì„ íƒí•˜ì„¸ìš”", "ìš´ì˜ì"] + PARTICIPANTS)
        if name_select == "ìš´ì˜ì":
            pw = st.text_input("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸", type="password")
            if st.button("ìš´ì˜ì ë¡œê·¸ì¸", use_container_width=True):
                if pw == "1234":
                    st.session_state.user = "ìš´ì˜ì"
                    st.rerun()
        elif name_select != "ì„ íƒí•˜ì„¸ìš”":
            if st.button(f"{name_select}ë‹˜ìœ¼ë¡œ ì‹œì‘", use_container_width=True):
                st.session_state.user = name_select
                st.rerun()

# --- 5. ë©”ì¸ í™”ë©´ ---
else:
    user = st.session_state.user

    # [ì‚¬ì´ë“œë°”] ë‚´ ì •ë³´ì™€ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ (ì ˆëŒ€ ì•ˆ ì‚¬ë¼ì§)
    with st.sidebar:
        st.markdown(f"# ğŸ‘¤ Profile")
        if user != "ìš´ì˜ì":
            my = st.session_state.db[user]
            st.image(my['avatar'], width=120)
            st.markdown(f"### `{my['nickname']}`")
            st.markdown(f"**ë‚´ê°€ ì±™ê¸¸ X:** <span style='color:#ff6b81; font-size:22px; font-weight:bold;'>{my['target']}</span>", unsafe_allow_html=True)
            st.write("---")

        if st.button("ğŸšª ë¡œê·¸ì•„ì›ƒ", use_container_width=True):
            del st.session_state.user
            st.rerun()

    if user == "ìš´ì˜ì":
        st.title("ğŸ•¶ï¸ ê´€ë¦¬ì ëª¨ë“œ")
        st.dataframe(pd.DataFrame([{"ì´ë¦„": k, "ëŒ€ìƒ": v['target']} for k, v in st.session_state.db.items()]))
    else:
        my = st.session_state.db[user]
        tab1, tab2, tab3 = st.tabs(["ğŸ’¬ ë‹¨ì²´í†¡", "ğŸ’Œ X-ëŒ€í™”", "ğŸ¯ ì¶”ë¦¬"])

        # [íƒ­ 1: ë‹¨ì²´í†¡] - ì •ì‹ ì±„íŒ… UI ì‚¬ìš© (ì½”ë“œ ë…¸ì¶œ ì•ˆë¨)
        with tab1:
            st.markdown("### ğŸŒ¸ í•‘í¬ ì‹œê·¸ë„ ê´‘ì¥")

            # ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì„ íƒì‚¬í•­)
            up_img = st.file_uploader("ì´ë¯¸ì§€ ê³µìœ ", type=['jpg','png'], label_visibility="collapsed")

            # ì±„íŒ… ì…ë ¥
            if prompt := st.chat_input("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."):
                st.session_state.global_chat.append({
                    "name": my['nickname'], "avatar": my['avatar'], "msg": prompt, "img": up_img
                })
                st.rerun()

            # ì±„íŒ… ì¶œë ¥
            for c in reversed(st.session_state.global_chat):
                with st.chat_message("user", avatar=c['avatar']):
                    st.write(f"**{c['name']}**")
                    if c['msg']: st.write(c['msg'])
                    if c['img']: st.image(c['img'], width=250)

        # [íƒ­ 2: X-ëŒ€í™”] - 1ëŒ€1 ì‹¤ì œ ëŒ€í™” ëŠë‚Œ
        with tab2:
            st.markdown(f"### ğŸ’Œ {my['target']}ë‹˜ì—ê²Œ ë³´ë‚´ëŠ” ì‹œê·¸ë„")
            target_db = st.session_state.db[my['target']]

            x_prompt = st.chat_input("Xì—ê²Œë§Œ ë³´ì´ëŠ” ë¹„ë°€ ë©”ì‹œì§€...", key="x_input")
            if x_prompt:
                # ë³´ë‚¸ ê¸°ë¡ (ë‚˜) / ë°›ì€ ê¸°ë¡ (ìƒëŒ€)
                my['x_chat'].append({"role": "sent", "msg": x_prompt})
                target_db['x_chat'].append({"role": "received", "sender": my['nickname'], "msg": x_prompt})
                st.toast("ì‹œê·¸ë„ì„ ë³´ëƒˆìŠµë‹ˆë‹¤! â¤ï¸")
                st.rerun()

            st.markdown("---")
            for chat in reversed(my['x_chat']):
                if chat['role'] == "received":
                    with st.chat_message("assistant", avatar="ğŸ’–"):
                        st.write(f"**{chat['sender']}ë‹˜ìœ¼ë¡œë¶€í„°**")
                        st.write(chat['msg'])
                else:
                    with st.chat_message("user", avatar="ğŸ“¤"):
                        st.write("**ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€**")
                        st.write(chat['msg'])

        # [íƒ­ 3: ì¶”ë¦¬]
        with tab3:
            st.markdown("<h2 style='text-align: center;'>ë‹¹ì‹ ì˜ XëŠ” ë‹¹ì‹ ì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤</h2>", unsafe_allow_html=True)
            guess = st.selectbox("ë‚˜ë¥¼ ì±™ê²¨ì¤€ ë§ˆë‹ˆë˜ëŠ” ëˆ„êµ¬ì¼ê¹Œìš”?", ["ì„ íƒí•˜ì„¸ìš”"] + PARTICIPANTS)
            if st.button("ìµœì¢… í™•ì¸", use_container_width=True):
                real_x = [k for k, v in st.session_state.db.items() if v['target'] == user][0]
                if guess == real_x:
                    st.balloons()
                    st.success(f"ì •ë‹µì…ë‹ˆë‹¤! {real_x}ë‹˜ì´ ë‹¹ì‹ ì˜ Xì˜€ìŠµë‹ˆë‹¤. ğŸ’–")
                else:
                    st.error("ì•„ì‰½ì§€ë§Œ ì •ë‹µì´ ì•„ë‹™ë‹ˆë‹¤. ğŸ¤«")