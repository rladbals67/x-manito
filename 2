import streamlit as st
import pandas as pd
import random

# --- 1. ì°¸ê°€ì ëª…ë‹¨ ì„¤ì • (ìš”ì²­í•˜ì‹  24ëª… ì´ë¦„ìœ¼ë¡œ ìˆ˜ì • ì™„ë£Œ) ---
PARTICIPANTS = [
    "ë‹¨ë¹„", "ì°½ìš°", "ì£¼í¬", "ì˜¨ìœ ", "ìœ ë¯¼", "ì£¼í˜•", 
    "ì˜ˆìŠ¬", "ë„í˜„", "ì„±í˜„", "ì‹ ì˜", "ì¤€ì¼", "ì£¼í™©",
    "ì§„ìˆ˜", "ì˜ì°¬", "ë‹¤ì—°", "ì˜ˆì›", "ì£¼í˜„", "ì´ëª…",
    "ì—°ì œ", "ìœ¤ì•„", "ë§ˆë¦¬ì•„", "ê·œì§„", "ì£¼í•œ", "ê±´ì–‘"
]

# --- 2. ì¹´í†¡ ìŠ¤íƒ€ì¼ ë””ìì¸ (CSS) ---
st.set_page_config(page_title="ğŸ’˜ í™˜ìŠ¹ ë§ˆë‹ˆë˜ : X-Signal", layout="centered")

st.markdown("""
    <style>
    .stApp { background-color: #abc1d1; } /* ì¹´í†¡ ë°°ê²½ìƒ‰ */
    .chat-bubble-me {
        display: flex; justify-content: flex-end; margin-bottom: 10px;
    }
    .chat-bubble-other {
        display: flex; justify-content: flex-start; margin-bottom: 10px;
    }
    .bubble {
        padding: 10px 15px; border-radius: 15px; max-width: 70%;
        font-size: 16px; line-height: 1.5; position: relative;
    }
    .me { background-color: #fee500; color: black; }
    .other { background-color: #ffffff; color: black; border: 1px solid #ddd; }
    .nickname { font-size: 12px; color: #555; margin-bottom: 2px; }
    </style>
    """, unsafe_allow_html=True)

# --- 3. ë°ì´í„° ì´ˆê¸°í™” (ë§ˆë‹ˆë˜ ë§¤ì¹­ ë° DB) ---
if 'db' not in st.session_state:
    targets = PARTICIPANTS[:]
    while True:
        random.shuffle(targets)
        # ìê¸° ìì‹ ì„ ë§ˆë‹ˆë˜ë¡œ ë½‘ì§€ ì•Šë„ë¡ ê²€ì¦
        if all(PARTICIPANTS[i] != targets[i] for i in range(len(PARTICIPANTS))):
            break
    
    db = {}
    for i, name in enumerate(PARTICIPANTS):
        target_name = targets[i]
        db[name] = {
            "nickname": f"{target_name}ë˜", 
            "target": target_name,
            "status": "ì•„ì§ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.",
            "messages": [] 
        }
    st.session_state.db = db
    st.session_state.global_chat = []

# --- 4. ë¡œê·¸ì¸ ë¡œì§ ---
if 'user' not in st.session_state:
    st.title("ğŸ’˜ í™˜ìŠ¹ ë§ˆë‹ˆë˜ : X-Signal")
    st.subheader("ë‹¹ì‹ ì˜ XëŠ” ë‹¹ì‹ ì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.")
    
    name_select = st.selectbox("ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”", ["ì„ íƒí•˜ì„¸ìš”", "ìš´ì˜ì"] + PARTICIPANTS)
    
    if name_select == "ìš´ì˜ì":
        pw = st.text_input("ìš´ì˜ì ë¹„ë°€ë²ˆí˜¸", type="password")
        if st.button("ìš´ì˜ì ë¡œê·¸ì¸"):
            if pw == "1234": # ë¹„ë°€ë²ˆí˜¸ëŠ” ì—¬ê¸°ì„œ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤.
                st.session_state.user = "ìš´ì˜ì"
                st.rerun()
            else: 
                st.error("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤!")
    elif name_select != "ì„ íƒí•˜ì„¸ìš”":
        if st.button("ì…ì¥í•˜ê¸°"):
            st.session_state.user = name_select
            st.rerun()
            
# --- 5. ë©”ì¸ í™”ë©´ ---
else:
    user = st.session_state.user
    
    # [ìš´ì˜ì ëª¨ë“œ]
    if user == "ìš´ì˜ì":
        st.title("ğŸ•¶ï¸ ê´€ì œ ì„¼í„° (ìš´ì˜ì)")
        if st.sidebar.button("ë¡œê·¸ì•„ì›ƒ"): 
            del st.session_state.user
            st.rerun()
            
        st.subheader("ğŸ“Š ì „ì²´ ë§¤ì¹­ í˜„í™©")
        m_data = [{"ë³¸ëª…": k, "ë‹‰ë„¤ì„": v['nickname'], "ëŒ€ìƒ": v['target'], "ìƒíƒœ": v['status']} for k, v in st.session_state.db.items()]
        st.table(pd.DataFrame(m_data))
        
        notice_msg = st.text_input("ğŸš¨ ê¸´ê¸‰ ê³µì§€ ì „ì†¡")
        if st.button("ê³µì§€ ì˜¬ë¦¬ê¸°"):
            if notice_msg:
                st.session_state.global_chat.append({"name": "ê´€ë¦¬ì", "msg": notice_msg, "is_notice": True})
                st.success("ê³µì§€ê°€ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.")

    # [ì‚¬ìš©ì ëª¨ë“œ]
    else:
        my_data = st.session_state.db[user]
        
        # ìƒë‹¨ ë°” ì •ë³´
        st.sidebar.title(f"ğŸ‘¤ {my_data['nickname']}")
        st.sidebar.write(f"ë‚˜ì˜ X(ì±™ê¸¸ ì‚¬ëŒ): **{my_data['target']}**")
        st.sidebar.write(f"ğŸ”” ì•Œë¦¼: {my_data['status']}")
        if st.sidebar.button("ë¡œê·¸ì•„ì›ƒ"):
            del st.session_state.user
            st.rerun()

        tab1, tab2, tab3 = st.tabs(["ğŸ’¬ ë‹¨ì²´í†¡", "ğŸ’Œ X-ë©”ì‹œì§€", "ğŸ¯ ì¶”ë¦¬"])

        # íƒ­ 1: ë‹¨ì²´í†¡
        with tab1:
            chat_input = st.chat_input("ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...")
            if chat_input:
                st.session_state.global_chat.append({"name": my_data['nickname'], "msg": chat_input, "is_notice": False})
                st.rerun()

            for chat in reversed(st.session_state.global_chat):
                if chat.get("is_notice"):
                    st.warning(f"ğŸ“¢ ê³µì§€: {chat['msg']}")
                else:
                    is_me = (chat['name'] == my_data['nickname'])
                    align = "chat-bubble-me" if is_me else "chat-bubble-other"
                    b_type = "me" if is_me else "other"
                    st.markdown(f"""
                        <div class="{align}">
                            <div>
                                <div class="nickname" style="text-align: {'right' if is_me else 'left'};">{chat['name']}</div>
                                <div class="bubble {b_type}">{chat['msg']}</div>
                            </div>
                        </div>
                        """, unsafe_allow_html=True)

        # íƒ­ 2: 1:1 ë¹„ë°€ ë©”ì‹œì§€
        with tab2:
            st.subheader(f"ë‚´ X({my_data['target']})ì—ê²Œ ë³´ë‚´ê¸°")
            s_msg = st.text_input("ìµëª… ìª½ì§€ë¥¼ ë³´ë‚´ì„¸ìš”", key="secret_input")
            if st.button("ìª½ì§€ ë°œì†¡"):
                if s_msg:
                    st.session_state.db[my_data['target']]['messages'].append(f"Xë¡œë¶€í„°: {s_msg}")
                    st.success(f"{my_data['target']}ë‹˜ì—ê²Œ ìµëª… ìª½ì§€ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤!")
            
            st.divider()
            st.subheader("ë‚˜ì—ê²Œ ì˜¨ ìª½ì§€")
            if not my_data['messages']:
                st.write("ì•„ì§ ë„ì°©í•œ ìª½ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.")
            for m in reversed(my_data['messages']):
                st.info(m)

        # íƒ­ 3: ì •ë‹µ ë§íˆê¸°
        with tab3:
            st.subheader("ë‹¹ì‹ ì˜ XëŠ” ëˆ„êµ¬ì…ë‹ˆê¹Œ?")
            st.write("ë‚˜ë¥¼ ì±™ê²¨ì£¼ê³  ìˆëŠ” 'ì§„ì§œ ë§ˆë‹ˆë˜'ë¥¼ ì°¾ì•„ë³´ì„¸ìš”.")
            guess = st.selectbox("ì˜ì‹¬ë˜ëŠ” ì‚¬ëŒ ì„ íƒ", ["ì„ íƒí•˜ì„¸ìš”"] + PARTICIPANTS)
            if st.button("ìµœì¢… ì„ íƒ í™•ì¸"):
                if guess != "ì„ íƒí•˜ì„¸ìš”":
                    # ë‚˜ë¥¼ ì±™ê²¨ì£¼ëŠ” ì‚¬ëŒ(ì§„ì§œ ë‚´ ë§ˆë‹ˆë˜) ì°¾ê¸°
                    real_x = [k for k, v in st.session_state.db.items() if v['target'] == user][0]
                    
                    if guess == real_x:
                        st.balloons()
                        st.success(f"ì •ë‹µì…ë‹ˆë‹¤! ë‹¹ì‹ ì˜ ë§ˆë‹ˆë˜ëŠ” {real_x}ë‹˜ì´ ë§ìŠµë‹ˆë‹¤. ğŸ¯")
                        st.session_state.db[real_x]['status'] = "ë‹¹ì‹ ì˜ ë§ˆë‹ˆë˜ê°€ ë‹¹ì‹ ì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤! â¤ï¸"
                    else:
                        st.error("í‹€ë ¸ìŠµë‹ˆë‹¤! ë‹¹ì‹ ì˜ ë§ˆë‹ˆë˜ê°€ ì•„ë‹™ë‹ˆë‹¤. ğŸ¤«")
                        st.session_state.db[real_x]['status'] = "ë‹¹ì‹ ì˜ ë§ˆë‹ˆë˜ê°€ ë‹¹ì‹ ì„ ì„ íƒí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ğŸ’”"
