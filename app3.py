# -*- coding: utf-8 -*-
"""app3

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1KpQQ3HhfGKGYGf8oDd6WvPc1eevP1J0k
"""

import streamlit as st
import pandas as pd
import random

# --- 1. ì°¸ê°€ì ì„¤ì • ---
PARTICIPANTS = ["ë‹¨ë¹„", "ì°½ìš°", "ì£¼í¬", "ì˜¨ìœ ", "ìœ ë¯¼", "ì£¼í˜•", "ì˜ˆìŠ¬", "ë„í˜„", "ì„±í˜„", "ì‹ ì˜", "ì¤€ì¼", "ì£¼í™©", "ì§„ìˆ˜", "ì˜ì°¬", "ë‹¤ì—°", "ì˜ˆì›", "ì£¼í˜„", "ì´ëª…", "ì—°ì œ", "ìœ¤ì•„", "ë§ˆë¦¬ì•„", "ê·œì§„", "ì£¼í•œ", "ê±´ì–‘"]

# ê·€ì—¬ìš´ í”„ë¡œí•„ ì´ë¯¸ì§€ ë¦¬ìŠ¤íŠ¸ (24ê°œ ëœë¤ ë°°ì •)
AVATARS = [f"https://api.dicebear.com/7.x/adventurer/svg?seed={name}" for name in PARTICIPANTS]

# --- 2. í•‘í¬ ëª½ê¸€ëª½ê¸€ ë””ìì¸ (CSS) ---
st.set_page_config(page_title="ğŸ’– X-Signal", layout="centered")

st.markdown("""
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&display=swap');

    .stApp { background: linear-gradient(180deg, #fff5f7 0%, #ffe4e8 100%); }

    /* ë§í’ì„  ìŠ¤íƒ€ì¼ ë° ì¤„ê¹¨ì§ ë°©ì§€ */
    .chat-row { display: flex; margin-bottom: 15px; align-items: flex-end; }
    .row-me { justify-content: flex-end; }
    .row-other { justify-content: flex-start; }

    .bubble {
        padding: 12px 18px; border-radius: 20px; max-width: 80%;
        font-size: 15px; line-height: 1.4; word-break: break-all; white-space: pre-wrap;
        box-shadow: 0px 2px 5px rgba(0,0,0,0.05);
    }
    .me { background-color: #ffb7c5; color: white; border-bottom-right-radius: 2px; }
    .other { background-color: white; color: #444; border-bottom-left-radius: 2px; }

    .avatar { width: 40px; height: 40px; border-radius: 50%; margin: 0 10px; border: 2px solid #fff; }
    .nick { font-size: 11px; color: #ff8fa3; margin-bottom: 4px; font-weight: bold; }

    /* í™˜ìŠ¹ì—°ì•  í°íŠ¸ ëŠë‚Œ */
    h1, h2, h3 { color: #ff6b81; font-family: 'Nanum Pen Script', cursive; }
    </style>
    """, unsafe_allow_html=True)

# --- 3. ë°ì´í„° ì´ˆê¸°í™” ---
if 'db' not in st.session_state:
    targets = PARTICIPANTS[:]
    while True:
        random.shuffle(targets)
        if all(PARTICIPANTS[i] != targets[i] for i in range(len(PARTICIPANTS))): break

    db = {}
    random.shuffle(AVATARS)
    for i, name in enumerate(PARTICIPANTS):
        db[name] = {
            "nickname": f"{targets[i]}ë˜",
            "avatar": AVATARS[i],
            "target": targets[i],
            "status": "ë‹¹ì‹ ì€ ì•„ì§ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤",
            "x_chat": [] # 1:1 ëŒ€í™” ë¡œê·¸
        }
    st.session_state.db = db
    st.session_state.global_chat = []

# --- 4. ë¡œê·¸ì¸ ---
if 'user' not in st.session_state:
    st.title("ğŸ’— ë‹¹ì‹ ì˜ XëŠ” ëˆ„êµ¬ì…ë‹ˆê¹Œ?")
    name_select = st.selectbox("ë‹¹ì‹ ì˜ ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”", ["ì„ íƒí•˜ì„¸ìš”", "ìš´ì˜ì"] + PARTICIPANTS)
    if name_select == "ìš´ì˜ì":
        pw = st.text_input("ë¹„ë°€ë²ˆí˜¸", type="password")
        if st.button("ì ‘ì†"):
            if pw == "1234": st.session_state.user = "ìš´ì˜ì"; st.rerun()
    elif name_select != "ì„ íƒí•˜ì„¸ìš”":
        if st.button("ì‹œì‘í•˜ê¸°"): st.session_state.user = name_select; st.rerun()

# --- 5. ë©”ì¸ í™”ë©´ ---
else:
    user = st.session_state.user
    if user == "ìš´ì˜ì":
        st.title("ğŸ•¶ï¸ ê´€ë¦¬ì ëª¨ë“œ")
        st.table(pd.DataFrame([{"ì´ë¦„": k, "ë§ˆë‹ˆë˜": v['target']} for k, v in st.session_state.db.items()]))
        if st.button("ë¡œê·¸ì•„ì›ƒ"): del st.session_state.user; st.rerun()
    else:
        my = st.session_state.db[user]

        tab1, tab2, tab3 = st.tabs(["ğŸ’¬ í•‘í¬í†¡", "ğŸ’Œ X-ëŒ€í™”", "ğŸ¯ ìµœì¢…ì„ íƒ"])

        # [íƒ­ 1: ë‹¨ì²´í†¡]
        with tab1:
            st.subheader("ëª¨ë‘ì™€ ì†Œí†µí•˜ëŠ” ê³µê°„")
            with st.container():
                img = st.file_uploader("ì´ë¯¸ì§€ ê³µìœ ", type=['jpg','png'], key="g_img")
                msg = st.chat_input("ë‹¹ì‹ ì˜ ë§ˆìŒì„ ì „í•˜ì„¸ìš”...")
                if msg or img:
                    st.session_state.global_chat.append({
                        "name": my['nickname'], "avatar": my['avatar'], "msg": msg, "img": img
                    })
                    st.rerun()

            for c in reversed(st.session_state.global_chat):
                is_me = (c['name'] == my['nickname'])
                align = "row-me" if is_me else "row-other"
                b_type = "me" if is_me else "other"

                avatar_html = f'<img src="{c["avatar"]}" class="avatar">'
                content_html = f'<div class="bubble {b_type}">{c["msg"]}</div>' if c['msg'] else ""

                st.markdown(f"""
                    <div class="chat-row {align}">
                        {'' if is_me else avatar_html}
                        <div style="max-width: 70%;">
                            <div class="nick" style="text-align: {'right' if is_me else 'left'};">{c['name']}</div>
                            {content_html}
                        </div>
                        {avatar_html if is_me else ''}
                    </div>
                    """, unsafe_allow_html=True)
                if c['img']: st.image(c['img'], width=200)

        # [íƒ­ 2: X-ëŒ€í™” (1:1)]
        with tab2:
            st.subheader(f"ë‚´ X({my['target']})ì™€ì˜ ëŒ€í™”")
            target_db = st.session_state.db[my['target']]

            x_msg = st.text_input("Xì—ê²Œ ë³´ë‚¼ ë©”ì‹œì§€")
            if st.button("ì „ì†¡"):
                # ìƒëŒ€ë°©ì˜ x_chatì— ë‚´ ë‹‰ë„¤ì„ìœ¼ë¡œ ì €ì¥
                target_db['x_chat'].append({"sender": my['nickname'], "msg": x_msg})
                st.success("ë©”ì‹œì§€ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤.")

            st.divider()
            st.write("ğŸ“¥ ë‚˜ì—ê²Œ ì˜¨ ìµëª… ë©”ì‹œì§€")
            for chat in reversed(my['x_chat']):
                st.markdown(f"""
                <div class="chat-row row-other">
                    <div class="bubble other"><b>{chat['sender']}:</b> {chat['msg']}</div>
                </div>
                """, unsafe_allow_html=True)

        # [íƒ­ 3: ì •ë‹µ]
        with tab3:
            st.markdown(f"### <center>\"{user}ë‹˜ì˜ XëŠ” ë‹¹ì‹ ì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤\"</center>", unsafe_allow_html=True)
            guess = st.selectbox("ëˆ„ê°€ ë‹¹ì‹ ì„ ì±™ê²¨ì£¼ê³  ìˆë‚˜ìš”?", ["ì„ íƒí•˜ì„¸ìš”"] + PARTICIPANTS)
            if st.button("í™•ì¸"):
                real_x = [k for k, v in st.session_state.db.items() if v['target'] == user][0]
                if guess == real_x:
                    st.balloons()
                    st.success("ì¶•í•˜í•©ë‹ˆë‹¤! ë§ˆìŒì´ í†µí–ˆë„¤ìš”. ğŸ’–")
                else:
                    st.error("XëŠ” ë‹¤ë¥¸ ì‚¬ëŒì¸ ê²ƒ ê°™ì•„ìš”. ğŸ¤«")