# -*- coding: utf-8 -*-
"""Untitled39.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1KpQQ3HhfGKGYGf8oDd6WvPc1eevP1J0k
"""

# -*- coding: utf-8 -*-
import streamlit as st
import pandas as pd
import random

# 1. ì›¹ì‚¬ì´íŠ¸ ê¸°ë³¸ ì„¤ì •
st.set_page_config(page_title="í™˜ìŠ¹ ë§ˆë‹ˆë˜ : X-Signal", layout="wide")

# 2. [ìˆ˜ì • í¬ì¸íŠ¸] ì°¸ì—¬ì ì‹¤ì œ ëª…ë‹¨
# ì—¬ê¸°ì— 30ëª…ì˜ ì´ë¦„ì„ ë‚˜ì—´í•˜ì„¸ìš”.
PARTICIPANTS = [
    "ë‹¨ë¹„", "ì°½ìš°", "ì£¼í¬", "ì˜¨ìœ ", "ìœ ë¯¼", "ì£¼í˜•",
    "ì˜ˆìŠ¬", "ë„í˜„", "ì„±í˜„", "ì‹ ì˜", "ì¤€ì¼", "ì£¼í™©",
    "ì§„ìˆ˜", "ì˜ì°¬", "ë‹¤ì—°", "ì˜ˆì›", "ì£¼í˜„", "ì´ëª…",
    "ì—°ì œ", "ìœ¤ì•„", "ë§ˆë¦¬ì•„", "ê·œì§„", "ì£¼í•œ", "ê±´ì–‘",
]

# 3. ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” (ìµœì´ˆ 1íšŒ ì‹¤í–‰)
if 'db' not in st.session_state:
    # ë§ˆë‹ˆë˜ ì„ê¸° (ìê¸° ìì‹  ì œì™¸)
    targets = PARTICIPANTS[:]
    while True:
        random.shuffle(targets)
        if all(PARTICIPANTS[i] != targets[i] for i in range(len(PARTICIPANTS))):
            break

    db = {}
    for i, name in enumerate(PARTICIPANTS):
        target_name = targets[i]
        # ë‹‰ë„¤ì„ ì„¤ì •: ë§ˆë‹ˆë˜ì´ë¦„ + "ë˜"
        custom_nickname = f"{target_name}ë˜"

        db[name] = {
            "nickname": custom_nickname,
            "target": target_name,
            "status": "ì•„ì§ ì§€ëª©ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.",
            "messages": []
        }
    st.session_state.db = db
    st.session_state.global_chat = []

# --- í™”ë©´ ìƒë‹¨ íƒ€ì´í‹€ ---
st.title("ğŸ’˜ í™˜ìŠ¹ ë§ˆë‹ˆë˜ : X-Signal")
st.markdown("---")

# 4. ë¡œê·¸ì¸ ë¡œì§
if 'user' not in st.session_state:
    st.subheader("ë¡œê·¸ì¸")
    login_name = st.selectbox("ë‹¹ì‹ ì˜ ì´ë¦„ì„ ì„ íƒí•˜ì„¸ìš”", ["ì„ íƒí•˜ì„¸ìš”", "ìš´ì˜ì"] + PARTICIPANTS)

    if login_name == "ìš´ì˜ì":
        # ìš”ì²­í•˜ì‹  ëŒ€ë¡œ ë¹„ë°€ë²ˆí˜¸ë¥¼ 4321ë¡œ ì„¤ì •í–ˆìŠµë‹ˆë‹¤.
        password = st.text_input("ìš´ì˜ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”", type="password")
        if st.button("ìš´ì˜ì ë¡œê·¸ì¸"):
            if password == "4321":
                st.session_state.user = "ìš´ì˜ì"
                st.rerun()
            else:
                st.error("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.")

    elif login_name != "ì„ íƒí•˜ì„¸ìš”":
        if st.button("ì…ì¥í•˜ê¸°"):
            st.session_state.user = login_name
            st.rerun()

# 5. ë¡œê·¸ì¸ ì„±ê³µ í›„ í™”ë©´
else:
    user = st.session_state.user

    # [A. ìš´ì˜ì í™”ë©´]
    if user == "ìš´ì˜ì":
        st.sidebar.title("ğŸ•¶ï¸ ê´€ì œ ì„¼í„°")
        if st.sidebar.button("ë¡œê·¸ì•„ì›ƒ"):
            del st.session_state.user
            st.rerun()

        m_tab1, m_tab2, m_tab3 = st.tabs(["ğŸ“Š ë§¤ì¹­ í˜„í™©", "ğŸ•µï¸ ì‹¤ì‹œê°„ ê°ì‹œ", "ğŸ“¢ ê³µì§€ì‚¬í•­"])

        with m_tab1:
            st.subheader("ì „ì²´ ë§ˆë‹ˆë˜ ë§¤ì¹­í‘œ")
            m_list = []
            for s, info in st.session_state.db.items():
                m_list.append({
                    "ë³¸ëª…": s,
                    "ë‹‰ë„¤ì„": info['nickname'],
                    "ì±™ê¸¸ ëŒ€ìƒ(ë§ˆë‹ˆë˜)": info['target'],
                    "ì§€ëª© ìƒíƒœ": info['status']
                })
            st.table(pd.DataFrame(m_list))

        with m_tab2:
            st.subheader("ìµœê·¼ ì „ë‹¬ëœ ìª½ì§€")
            for r, info in st.session_state.db.items():
                if info['messages']:
                    st.write(f"**{r}**ì—ê²Œ ì˜¨ ë©”ì‹œì§€: {info['messages'][-1]}")

        with m_tab3:
            notice_text = st.text_input("ì „ì²´ ê³µì§€ ë©”ì‹œì§€")
            if st.button("ê³µì§€ ì „ì†¡"):
                st.session_state.global_chat.append(f"ğŸš¨ [ê³µì§€] {notice_text}")
                st.success("ê³µì§€ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.")

    # [B. ì¼ë°˜ ì‚¬ìš©ì í™”ë©´]
    else:
        my_data = st.session_state.db[user]

        # ì‚¬ì´ë“œë°” ì •ë³´
        st.sidebar.title(f"ğŸ‘¤ {user}")
        st.sidebar.write(f"ë‚˜ì˜ ë‹‰ë„¤ì„: **{my_data['nickname']}**")
        st.sidebar.info(f"ë‚´ê°€ ì±™ê¸¸ ì‚¬ëŒ: **{my_data['target']}**")
        st.sidebar.markdown(f"**í˜„ì¬ ë‚´ ìƒíƒœ:**\n{my_data['status']}")

        if st.sidebar.button("ë¡œê·¸ì•„ì›ƒ"):
            del st.session_state.user
            st.rerun()

        # ë©”ì¸ íƒ­ êµ¬ì„±
        tab1, tab2, tab3 = st.tabs(["ğŸ’¬ ë‹¨ì²´ ìµëª…í†¡", "ğŸ’Œ X-ë©”ì‹œì§€", "ğŸ¯ ì˜¤ëŠ˜ì˜ ì„ íƒ"])

        # íƒ­ 1: ë‹¨ì²´í†¡
        with tab1:
            st.subheader("ì „ì²´ ìµëª… ì±„íŒ…ë°©")
            chat_msg = st.text_input("ë‚´ìš© ì…ë ¥", key="global_input")
            if st.button("ì „ì†¡"):
                if chat_msg:
                    st.session_state.global_chat.append(f"[{my_data['nickname']}] {chat_msg}")
                    st.rerun()

            for m in reversed(st.session_state.global_chat):
                st.write(m)

        # íƒ­ 2: ë§ˆë‹ˆë˜ì—ê²Œ ìª½ì§€
        with tab2:
            st.subheader(f"ë‚´ ë§ˆë‹ˆë˜({my_data['target']})ì—ê²Œ ìª½ì§€ ë³´ë‚´ê¸°")
            to_send = st.text_area("ìµëª…ìœ¼ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.", key="secret_area")
            if st.button("ìª½ì§€ ë³´ë‚´ê¸°"):
                if to_send:
                    target = my_data['target']
                    st.session_state.db[target]['messages'].append(f"Xë¡œë¶€í„°: {to_send}")
                    st.success("ìƒëŒ€ë°©ì˜ ë³´ê´€í•¨ì— ìª½ì§€ë¥¼ ë„£ì—ˆìŠµë‹ˆë‹¤.")

            st.divider()
            st.subheader("ë‚˜ì—ê²Œ ì˜¨ ìª½ì§€í•¨")
            for m in reversed(my_data['messages']):
                st.write(f"ğŸ“© {m}")

        # íƒ­ 3: ì •ë‹µ ë§íˆê¸°
        with tab3:
            st.subheader("ëˆ„ê°€ ë‚˜ë¥¼ ì±™ê²¨ì£¼ê³  ìˆì„ê¹Œ?")
            guess = st.selectbox("ì˜ì‹¬ë˜ëŠ” ì‚¬ëŒì˜ ë³¸ëª…ì„ ì„ íƒí•˜ì„¸ìš”", ["ì„ íƒí•˜ì„¸ìš”"] + PARTICIPANTS)

            if st.button("ì§€ëª©í•˜ê¸°"):
                if guess == "ì„ íƒí•˜ì„¸ìš”":
                    st.warning("ì´ë¦„ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.")
                else:
                    real_x = ""
                    for k, v in st.session_state.db.items():
                        if v['target'] == user:
                            real_x = k

                    if guess == real_x:
                        st.balloons()
                        st.success(f"ë§ì•˜ìŠµë‹ˆë‹¤! {guess}ë‹˜ì€ ë‹¹ì‹ ì˜ ë§ˆë‹ˆë˜ì…ë‹ˆë‹¤. ğŸ¯")
                        st.session_state.db[real_x]['status'] = "ë‹¹ì‹ ì˜ ë§ˆë‹ˆë˜ê°€ ë‹¹ì‹ ì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤! â¤ï¸"
                    else:
                        st.error(f"í‹€ë ¸ìŠµë‹ˆë‹¤! {guess}ë‹˜ì€ ë‹¹ì‹ ì˜ ë§ˆë‹ˆë˜ê°€ ì•„ë‹™ë‹ˆë‹¤. ğŸ¤«")
                        if real_x:
                            st.session_state.db[real_x]['status'] = "ë‹¹ì‹ ì˜ ë§ˆë‹ˆë˜ê°€ ë‹¹ì‹ ì„ ì„ íƒí•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ğŸ’”"